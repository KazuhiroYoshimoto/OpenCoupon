

<script>
var img_id = parseInt(0);
function del_image(img_id){

	try {
		req = new ActiveXObject("Microsoft.XMLHTTP");
	} catch(e) {
		req = new XMLHttpRequest();
	}

	req.onreadystatechange = function()
	{
		var msg = document.getElementById("image_message");
		if (req.readyState == 4){
			if (req.status == 200){
					var data = req.responseText;
					var result = eval( '(' + data + ')' );
					//console.log(result);
					var to_delete = String(result.deleted);
					var img_pv = document.getElementById(to_delete);
					//console.log(img_pv);
					//console.log(to_delete);
					img_pv.parentNode.removeChild(img_pv);
					msg.removeChild(msg.firstChild);
				
					var input_to_delete = to_delete+'_image';
					var del_target = document.getElementById(input_to_delete);
					//console.log(del_target);
					//console.log(input_to_delete);
					del_target.parentNode.removeChild(del_target);
			} else {
				msg.innerHTML ="削除に失敗しました。";
			}
		} else {
			msg.innerHTML ="削除しています...";//メッセージ不要かも。
		}
	}

	req.open("post", "./del_image/", true);
	req.setRequestHeader("content-type", "application/x-www-form-urlencoded;");
	req.send(encodeURI('to_delete='+img_id));

}


function CheckImgCount(){
	var pv_div   = document.getElementById("uploaded_image");
	var pv_count = pv_div.getElementsByTagName("img");
	var len      = pv_count.length;
	//console.log(len);//for test
	var img_max = 10;
	if( len >= img_max ){
		alert('画像は '+img_max+' 枚まで指定できます。');
		document.getElementById('form_coupon_image').reset();
		return false;
	}else{
		return true;
	}
}

function CheckImgCountMin(){
	var regexp   = new RegExp("^[a-zA-Z0-9]{32}_image$");
	console.log(regexp);
	//img_input = String(img_input);

	form_to_send = document.getElementsByTagName('form')[0];
	console.log(form_to_send);
	
	var input_tags  = form_to_send.getElementsByTagName('input');
	console.log(input_tags);

	var input_count = 0;
	for(var i =0;i<input_tags.length;i++){
		if(regexp.test(input_tags[i].getAttribute("id"))){
			input_count++;
		}
	}
	console.log(input_count);
	
	var img_min = 1;//★便宜上1枚以上に設定中。要修正★
	var img_max = 10;
	if( input_count < img_min ){
		alert('画像を '+img_min+' 枚以上指定してください。');
		return false;
	}else if( input_count >= img_max ){
		alert('画像は '+img_max+' 枚まで指定できます。');
		return false;
	}else{
		return true;
	}
}


</script>


<div class="contents">
	<div class="hgroup1" style="font-size: 20px; border-bottom: 1px solid #D9D9D9; margin-top: 8px; padding-bottom: 13px;">
		<h1 style="font-size: 20px;">クーポン購入</h1>
	</div>
	<h2 style="border-bottom: 4px solid #B0D485; margin-bottom: 10px; padding-top: 13px; font-size: 20px;">購入内容</h2>
	<div id="coupon_content" style="padding-top:8px;">
		
		<?php $this->form()->Start('form_coupon','confirm') ?>
		<table>
			<tr>
				<?php /* タイトル */ ?>
				<td>
					<?php $this->form()->Label('coupon_title') ?>
				</td>
				<td>
					<?php $this->form()->Input('coupon_title') ?><br/>
					<?php $this->form()->Error('coupon_title') ?>
				</td>
			</tr>
			<tr>
				<?php /* 説明 */ ?>
				<td>
					<?php $this->form()->Label('coupon_description') ?>
				</td>
				<td>
					<?php $this->form()->Input('coupon_description') ?><br/>
					<?php $this->form()->Error('coupon_description') ?>
				</td>
			</tr>
			<tr>
				<?php /* 通常価格 */ ?>
				<td>
					<?php $this->form()->Label('coupon_normal_price') ?>
				</td>
				<td>
					<?php $this->form()->Input('coupon_normal_price') ?><br/>
					<?php $this->form()->Error('coupon_normal_price') ?>
				</td>
			</tr>
			<tr>
				<?php /* 販売価格 */ ?>
				<td>
					<?php $this->form()->Label('coupon_sales_price') ?>
				</td>
				<td>
					<?php $this->form()->Input('coupon_sales_price') ?><br/>
					<?php $this->form()->Error('coupon_sales_price') ?>
				</td>
			</tr>
			<tr>
				<?php /* 最大販売数 */ ?>
				<td>
					<?php $this->form()->Label('coupon_sales_num_top') ?>
				</td>
				<td>
					<?php $this->form()->Input('coupon_sales_num_top') ?><br/>
					<?php $this->form()->Error('coupon_sales_num_top') ?>
				</td>
			</tr>
			<tr>
				<?php /* 最小販売数 */ ?>
				<td>
					<?php $this->form()->Label('coupon_sales_num_bottom') ?>
				</td>
				<td>
					<?php $this->form()->Input('coupon_sales_num_bottom') ?><br/>
					<?php $this->form()->Error('coupon_sales_num_bottom') ?>
				</td>
			</tr>
			<tr>
				<?php /* 販売開始日時 */ ?>
				<td>
					<?php $this->form()->Label('coupon_sales_start') ?>
				</td>
				<td>
					<?php $this->form()->Input('coupon_sales_start') ?><br/>
					<?php $this->form()->Error('coupon_sales_start') ?>
				</td>
			</tr>
			<tr>
				<?php /* 終了開始日時 */ ?>
				<td>
					<?php $this->form()->Label('coupon_sales_finish') ?>
				</td>
				<td>
					<?php $this->form()->Input('coupon_sales_finish') ?><br/>
					<?php $this->form()->Error('coupon_sales_finish') ?>
				</td>
			</tr>
			<tr>
				<?php /* 有効期限 */ ?>
				<td>
					<?php $this->form()->Label('coupon_expire') ?>
				</td>
				<td>
					<?php $this->form()->Input('coupon_expire') ?><br/>
					<?php $this->form()->Error('coupon_expire') ?>
				</td>
			</tr>
			<tr>
				<?php /* 一人が購入できる枚数 */ ?>
				<td>
					<nobr><?php $this->form()->Label('coupon_person_num') ?></nobr>
				</td>
				<td>
					<?php $this->form()->Input('coupon_person_num') ?><br/>
					<?php $this->form()->Error('coupon_person_num') ?>
<!-- <input type="hidden" name="MAX_FILE_SIZE" value="2000000" >  -->
					</td>
			</tr>
			
			<?php /*
			<tr>
				<td>
					<?php $this->form()->Label('coupon_image') ?>
				</td>
				<td>
					<?php if( $path = $this->form()->GetInputValue('coupon_image') ): ?>
						<img src="<?=$path?>"/>
					<?php endif; ?>
					<?php $this->form()->Input('coupon_image') ?><br/>
					<?php $this->form()->Error('coupon_image') ?>
				</td>
			</tr>
			*/ ?>
			
			</table>
			
		<?php /* ネガティブマージン用。要調整。
		<div style="width: 100%; height:100px;"></div>
		<div style="height:200px;"></div>
		*/ ?>
		
		<div style="text-align:center">
			<!-- <input type="button" name="check" value="check" onclick="return CheckImgCountMin();"> -->
			<?php $this->form()->Input( 'submit', '　入力内容の確認　') ?>
		</div>
		<?php $array = null;?>
		<?php if($_POST):?>
			<?php $value = $_POST;?>
			<?php //$array = null;?>
			<?php //$this->d($value);?>
			<?php foreach( $value as $key => $val):?>
				<?php if( preg_match( '/^image_[a-zA-Z0-9]{32}$/', $key ) and $val !== null ):?>
				<?php $array[$key] = $val;?>
				<?php endif;?>
			<?php endforeach;?>
			
<?php if($array):?>
	<?php foreach( $array as $k => $v ):?>
		<?php $k2 = str_replace("image_", "", $k);?>
	<?php //$this->d($k);?>
	<?php //$this->d($v);?>
<?php print '<input id="';?>
<?php print $k2.'_image';?>
<?php print '" type="hidden" name="';?>
<?=$k?>
<?php print '" value="';?>
<?=$v?>
<?php print '">';?>
		<?php endforeach;?>
<?php endif;?>		
			
		<?php endif;?>
		
		<?php $this->form()->Finish('form_coupon') ?>
		

		<div>
		<form name="form_coupon_image" enctype="multipart/form-data" method="post" action="./upload/" target="targetFrame" id="form_coupon_image">
			<input type="hidden" name="MAX_FILE_SIZE" value="2000000" >
			<input type="file" name="upload_image" required><br>
			<!-- <input type="submit" value="画像をアップロード" > -->
			<input type="submit" value="画像をアップロード" onClick="return CheckImgCount();">
		</form>
		</div>
		
		<?php /*
		<div><!-- op-core使ってアップロードフォーム記述したテスト。targetの指定に対応していないため未使用 -->
		<?php $this->form()->Start('form_coupon_image','./upload/') ?>
		<?php $this->form()->Input('max_file_size') ?>
		
		<?php $this->form()->Label('upload_image') ?>
		<?php $this->form()->Input('upload_image') ?><br>
		
		<?php $this->form()->Input('submit') ?>
		
		<?php $this->form()->Finish('form_coupon_image') ?>
		</div>
		*/ ?>
		
		<div id="image_message"><!-- ★これ使ってないので削除するかも。★ -->
		</div>
		
		<div id="uploaded_image">
<?php //$value = $this->form()->GetInputValueRawAll('form_coupon');?>
<?php //$array = null;?>
<?php //$this->d($value);?>

<?php //$value = $_POST;?>
<?php //$array = null;?>
<?php //$this->d($value);?>
<?php //foreach( $value as $key => $val):?>
	<?php //if( preg_match( '/^[a-z]{5}_[a-zA-Z0-9]{32}$/', $key ) and $val !== null ):?>
		<?php //$array[$key] = $val;?>
	<?php //endif;?>
<?php //endforeach;?>
<?php //$i = 1;//不要？?>
<?php //$this->d($array);?>
<?php if($array):?>
	<?php foreach( $array as $k => $v ):?>
	<?php $k = str_replace("image_", "", $k);?>
	<?php $v = $this->ConvertUrl("app:$v");?>
	<?php //$this->d($k);?>
	<?php //$this->d($v);?>
<?php print '<div class="uploaded_image" id="';?>
<?php print $k;?>
<?php print '">';?>
<?php print '<div>';?>
<?php print '<img src="';?>
<?php print $v;?>
<?php print '" width="100" height="75">';?>
<?php print '</div>';?>
<?php print '<div>';?>
<?php print '<span class="image_del_button">';?>
<?php print '<a href="javascript: del_image(\'';?>
<?php print $k; ?>
<?php print '\')">[x]</a>';?>
<?php print '</span>';?>
<?php print '</div>';?>
<?php print '</div>';?>
	<?php endforeach;?>
<?php endif;?>		
		</div>
		
		<div id="result">
		<!-- <iframe id="targetFrame" src="" style="width:0px;height:0px;border:0px;"></iframe> -->
		<!-- ★現在テストのためiframe表示中★ -->
		<iframe id="targetFrame" src="" style="width:400px;height:200px;"></iframe>
		</div>
		
		
		
		<?php /* ネガティブマージン用。要調整。
		<div style="width:100%;height:200px;margin-top:-300px;">
		<table>
		
		<?php $this->form()->Start('form_coupon_image') ?>

			<tr>
				<td>
					<?php $this->form()->Label('coupon_image_1') ?>
				</td>
				<td>
					<?php if( $path = $this->form()->GetInputValue('coupon_image_1') ): ?>
						<img src="<?=$path?>"/>
					<?php endif; ?>
					<?php $this->form()->Input('coupon_image_1') ?><br/>
					<?php $this->form()->Error('coupon_image_1') ?>
				</td>
			</tr>
		
		
		</table>
		</div>
		<div style="text-align:center">
		<?php $this->form()->Input( 'submit' ) ?>
		<?php $this->form()->Finish('form_coupon_image') ?>
		</div>
		*/ ?>
	</div>
</div>
